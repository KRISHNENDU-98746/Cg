<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firestore Store + Wallet</title>
<style>
  body{font-family:'Poppins',sans-serif;margin:0;background:#f6f7fb;}
  nav{background:#222;color:white;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;}
  nav input{padding:6px 10px;border-radius:8px;border:none;outline:none;}
  nav button{border:none;border-radius:8px;padding:6px 12px;cursor:pointer;}
  #logoutBtn{background:#f44336;color:white;}
  #cartBtn{background:#4CAF50;color:white;}
  #walletArea{display:flex;align-items:center;gap:8px;font-weight:bold;}
  #addGiftBtn{background:none;border:none;color:#4CAF50;font-size:20px;cursor:pointer;}
  #product-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:20px;justify-items:center;}
  .product{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;text-align:center;transition:transform .2s;cursor:pointer;}
  .product:hover{transform:translateY(-3px);}
  .product img{width:100%;height:180px;object-fit:cover;border-radius:8px;}
  .add-btn{background:#4CAF50;color:white;border:none;padding:6px 12px;border-radius:8px;margin-top:6px;cursor:pointer;}
  #cartDrawer{position:fixed;top:0;right:-400px;width:350px;height:100%;background:white;box-shadow:-2px 0 8px rgba(0,0,0,0.2);transition:right .3s;padding:20px;overflow-y:auto;z-index:10;}
  #cartDrawer.active{right:0;}
  .cart-item{display:flex;align-items:center;justify-content:space-between;margin:10px 0;border-bottom:1px solid #eee;padding-bottom:8px;}
  .cart-total{font-weight:bold;margin-top:20px;}
  .checkout-btn{width:100%;background:#4CAF50;color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;margin-top:10px;}
  #checkoutPopup,#giftPopup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:20;}
  .popup-box{background:white;padding:20px;border-radius:10px;width:400px;}
  .popup-box input{width:100%;padding:8px;margin-top:10px;border:1px solid #ccc;border-radius:6px;}
  .popup-box button{width:100%;margin-top:10px;padding:10px;border:none;border-radius:8px;cursor:pointer;}
  #closeGift,#closeCheckout{background:#f44336;color:white;}
  #redeemGift,#placeOrder{background:#4CAF50;color:white;}
</style>
</head>
<body>

<!-- NAVIGATION -->
<nav>
  <div>Firestore Store</div>
  <input type="text" id="searchBar" placeholder="Search products...">
  <div id="walletArea">
    <span id="walletDisplay">üí∞ Wallet: ‚Çπ0</span>
    <button id="addGiftBtn">Ôºã</button>
  </div>
  <div>
    <button id="cartBtn">üõí Cart</button>
    <button id="logoutBtn">Logout</button>
  </div>
</nav>

<!-- PRODUCT GRID -->
<div id="product-grid"></div>

<!-- CART DRAWER -->
<div id="cartDrawer">
  <h2>Your Cart</h2>
  <div id="cartItems"></div>
  <p class="cart-total">Total: ‚Çπ<span id="cartTotal">0</span></p>
  <button class="checkout-btn" id="checkoutBtn">Checkout</button>
</div>

<!-- CHECKOUT POPUP -->
<div id="checkoutPopup">
  <div class="popup-box">
    <h2>Shipping Address</h2>
    <input id="rName" placeholder="Recipient Name">
    <input id="rStreet1" placeholder="Street Address 1">
    <input id="rCity" placeholder="City">
    <input id="rState" placeholder="State/Province">
    <input id="rZip" placeholder="Zip/Postal Code">
    <input id="rCountry" placeholder="Country">
    <input id="rPhone" placeholder="Phone Number">
    <button id="placeOrder">Place Order</button>
    <button id="closeCheckout">Cancel</button>
  </div>
</div>

<!-- GIFT REDEEM POPUP -->
<div id="giftPopup">
  <div class="popup-box">
    <h2>üéÅ Redeem Gift Card</h2>
    <input id="giftCode" placeholder="Enter gift card code">
    <button id="redeemGift">Redeem</button>
    <button id="closeGift">Cancel</button>
    <p id="giftMsg" style="font-size:14px;color:green;"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyD7CGdjI-VaNl2AnB54dPAVBh9mAIF9j7o",
  authDomain:"thelong-6274a.firebaseapp.com",
  projectId:"thelong-6274a",
  storageBucket:"thelong-6274a.firebasestorage.app",
  messagingSenderId:"729094241594",
  appId:"1:729094241594:web:17b32ea302bb45814fa403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const productGrid=document.getElementById("product-grid");
const walletDisplay=document.getElementById("walletDisplay");
const addGiftBtn=document.getElementById("addGiftBtn");
const giftPopup=document.getElementById("giftPopup");
const giftCode=document.getElementById("giftCode");
const giftMsg=document.getElementById("giftMsg");
const redeemGift=document.getElementById("redeemGift");
const closeGift=document.getElementById("closeGift");
const checkoutPopup=document.getElementById("checkoutPopup");
const cartDrawer=document.getElementById("cartDrawer");
const cartItems=document.getElementById("cartItems");
const cartTotal=document.getElementById("cartTotal");

let allProducts=[],cart=[],currentUser=null,walletBalance=0;

// --- AUTH ---
onAuthStateChanged(auth, async (user)=>{
  if(user){ currentUser=user; await loadProducts(); await loadCart(); await loadWallet(); }
  else signInWithPopup(auth,provider);
});
document.getElementById("logoutBtn").onclick=()=>signOut(auth);

// --- LOAD PRODUCTS ---
async function loadProducts(){
  const snap=await getDocs(collection(db,"products"));
  allProducts=snap.docs.map(d=>({id:d.id,...d.data()}));
  displayProducts(allProducts);
}
function displayProducts(list){
  productGrid.innerHTML="";
  list.forEach(p=>{
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`<img src="${p.image||'https://via.placeholder.com/200'}"><h3>${p.name}</h3><p>‚Çπ${p.price}</p><button class="add-btn">Add to Cart</button>`;
    div.querySelector(".add-btn").onclick=(e)=>{e.stopPropagation();addToCart(p.id,p.name,p.price,p.image);}
    productGrid.appendChild(div);
  });
}

// --- SEARCH ---
document.getElementById("searchBar").oninput=()=>{
  const key=searchBar.value.toLowerCase();
  const filtered=allProducts.filter(p=>p.name.toLowerCase().includes(key));
  displayProducts(filtered);
};

// --- CART ---
async function addToCart(id,name,price,image){
  const ex=cart.find(i=>i.id===id);
  if(ex)ex.qty++; else cart.push({id,name,price,image,qty:1});
  await saveCart();updateCart();
}
function updateCart(){
  cartItems.innerHTML=cart.map(i=>`<div class="cart-item"><span>${i.name} x${i.qty}</span><span>‚Çπ${i.price*i.qty}</span></div>`).join("");
  cartTotal.textContent=cart.reduce((s,i)=>s+i.price*i.qty,0);
}
document.getElementById("cartBtn").onclick=()=>cartDrawer.classList.toggle("active");
async function saveCart(){if(currentUser)await setDoc(doc(db,"carts",currentUser.uid),{items:cart});}
async function loadCart(){const snap=await getDoc(doc(db,"carts",currentUser.uid));cart=snap.exists()?snap.data().items:[];updateCart();}

// --- WALLET ---
async function loadWallet(){
  const ref=doc(db,"users",currentUser.uid);
  const snap=await getDoc(ref);
  if(snap.exists())walletBalance=snap.data().balance||0;
  else{await setDoc(ref,{balance:0});walletBalance=0;}
  walletDisplay.textContent=`üí∞ Wallet: ‚Çπ${walletBalance}`;
}

// --- GIFT REDEEM (Adds to Wallet) ---
addGiftBtn.onclick=()=>giftPopup.style.display="flex";
closeGift.onclick=()=>giftPopup.style.display="none";
redeemGift.onclick=async()=>{
  const code=giftCode.value.trim();
  if(!code)return alert("Enter gift card code!");
  const ref=doc(db,"giftcards",code);
  const snap=await getDoc(ref);
  if(!snap.exists())return giftMsg.textContent="‚ùå Invalid code!";
  const data=snap.data();
  if(data.redeemed)return giftMsg.textContent="‚ö†Ô∏è Already used!";
  const amount=data.amount||0;
  walletBalance+=amount;
  await updateDoc(ref,{redeemed:true,usedBy:currentUser.uid});
  await updateDoc(doc(db,"users",currentUser.uid),{balance:walletBalance});
  walletDisplay.textContent=`üí∞ Wallet: ‚Çπ${walletBalance}`;
  giftMsg.textContent=`üéâ ‚Çπ${amount} added to wallet!`;
};

// --- CHECKOUT ---
document.getElementById("checkoutBtn").onclick=()=>checkoutPopup.style.display="flex";
document.getElementById("closeCheckout").onclick=()=>checkoutPopup.style.display="none";

document.getElementById("placeOrder").onclick=async()=>{
  const total=cart.reduce((s,i)=>s+i.price*i.qty,0);
  const pay=Math.max(total-walletBalance,0);
  const usedWallet=Math.min(total,walletBalance);
  walletBalance-=usedWallet;
  await updateDoc(doc(db,"users",currentUser.uid),{balance:walletBalance});
  await addDoc(collection(db,"orders"),{
    userId:currentUser.uid,items:cart,total:total,paid:pay,walletUsed:usedWallet,createdAt:serverTimestamp()
  });
  alert(`‚úÖ Order placed! Paid ‚Çπ${pay} (Used ‚Çπ${usedWallet} from wallet)`);
  cart=[];await saveCart();updateCart();checkoutPopup.style.display="none";walletDisplay.textContent=`üí∞ Wallet: ‚Çπ${walletBalance}`;
};
</script>
</body>
</html>
