<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mini Amazon Clone ‚Äî Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic modern styling */
    :root { --accent: #ff9900; --muted:#666; --card:#fff; --bg:#f6f7f8; }
    body { font-family: Inter, Roboto, Arial, sans-serif; background:var(--bg); margin:0; color:#111; }
    header { background:#111; color:#fff; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    header h1 { margin:0; font-size:18px; display:flex; gap:8px; align-items:center; }
    .btn { background:var(--accent); color:#111; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#eee; color:#111; }
    .container { max-width:1100px; margin:22px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start; }
    .products { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:16px; }
    .card { background:var(--card); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(15,15,15,0.06); }
    .product img { width:100%; height:180px; object-fit:cover; border-radius:8px; }
    .product h3 { margin:10px 0 6px; font-size:16px; }
    .muted { color:var(--muted); font-size:13px; }
    .cart { position:sticky; top:20px; }
    .cart h3 { margin:0 0 8px; }
    .field { display:flex; gap:8px; margin-bottom:8px; }
    input, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; }
    #notification { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:10px; display:none; z-index:9999; }
    .admin-form { margin-top:16px; }
    footer { text-align:center; color:var(--muted); padding:26px 12px; }
  </style>
</head>
<body>
  <header>
    <h1>üõí Mini Amazon Clone</h1>
    <div id="authArea">
      <button id="googleLogin" class="btn">Login with Google</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Left: product list -->
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h2 style="margin:0">Products</h2>
          <div class="muted" id="userInfoSmall"></div>
        </div>

        <div id="productGrid" class="products">
          <!-- products will render here -->
        </div>

        <!-- Admin product add form (hidden unless admin) -->
        <div id="adminArea" class="admin-form" style="display:none;">
          <div class="card" style="margin-top:16px;">
            <h3>Add Product (Admin)</h3>
            <div class="field"><input id="pName" placeholder="Product name"></div>
            <div class="field"><input id="pPrice" type="number" placeholder="Price (number)"></div>
            <div class="field"><input id="pImage" placeholder="Image URL (use https)"></div>
            <div class="field"><textarea id="pDesc" rows="3" placeholder="Short description"></textarea></div>
            <div style="text-align:right;">
              <button id="addProductBtn" class="btn">Add Product</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: cart & checkout -->
      <aside class="cart">
        <div class="card">
          <h3>üõç Your Cart</h3>
          <div id="cartItems"><p class="muted">Cart is empty</p></div>
          <h4>Total: $<span id="cartTotal">0.00</span></h4>
          <textarea id="shipping" placeholder="Shipping address" rows="3" style="margin-top:8px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="checkoutBtn" class="btn" style="flex:1">Checkout</button>
            <button id="clearCart" class="btn secondary" style="flex:1">Clear</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div id="notification"></div>
  <footer>Demo app ‚Äî uses Firebase Firestore & Auth</footer>

  <script type="module">
    // ---------- FIREBASE SDK IMPORTS ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, addDoc, doc, setDoc, getDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD7CGdjI-VaNl2AnB54dPAVBh9mAIF9j7o",
      authDomain: "thelong-6274a.firebaseapp.com",
      databaseURL: "https://thelong-6274a-default-rtdb.firebaseio.com",
      projectId: "thelong-6274a",
      storageBucket: "thelong-6274a.appspot.com",
      messagingSenderId: "729094241594",
      appId: "1:729094241594:web:17b32ea302bb45814fa403",
      measurementId: "G-DPSPS3MDBF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---------- UI REFERENCES ----------
    const googleLogin = document.getElementById('googleLogin');
    const authArea = document.getElementById('authArea');
    const userInfoSmall = document.getElementById('userInfoSmall');
    const productGrid = document.getElementById('productGrid');
    const notification = document.getElementById('notification');
    const cartItemsDiv = document.getElementById('cartItems');
    const cartTotalSpan = document.getElementById('cartTotal');
    const shippingBox = document.getElementById('shipping');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const clearCartBtn = document.getElementById('clearCart');

    // Admin UI
    const adminArea = document.getElementById('adminArea');
    const addProductBtn = document.getElementById('addProductBtn');
    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pImage = document.getElementById('pImage');
    const pDesc = document.getElementById('pDesc');

    // ---------- Simple in-memory cart (will sync to Firestore per-user) ----------
    let localCart = { items: [], total: 0 };
    let currentUser = null;
    let cartDocRef = null;
    let cartUnsubscribe = null;

    // ---------- Define Admins (emails) ----------
    // Replace with the admin email(s) you want to allow to add products
    const ADMINS = [
      // example: "admin@example.com"
      // Add your Google account email here to see the admin product form
      // "youremail@example.com"
    ];

    // ---------- Helpers ----------
    function showNotification(msg, ms = 3000) {
      notification.textContent = msg;
      notification.style.display = 'block';
      setTimeout(() => { notification.style.display = 'none'; }, ms);
    }

    function formatPrice(n) {
      return Number(n).toFixed(2);
    }

    // ---------- AUTH ----------
    googleLogin.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        showNotification(err.message || 'Auth error');
      }
    };

    async function signOutUI() {
      try {
        await signOut(auth);
        showNotification('Signed out');
      } catch (e) {
        console.error(e);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        renderAuthUI(user);
        // Setup per-user cart doc ref and real-time syncing
        cartDocRef = doc(db, 'users', user.uid, 'cart', 'current');
        if (cartUnsubscribe) cartUnsubscribe();
        cartUnsubscribe = onSnapshot(cartDocRef, (snap) => {
          if (snap.exists()) {
            localCart = snap.data();
          } else {
            localCart = { items: [], total: 0 };
          }
          renderCart();
        }, (err) => {
          console.error('Cart listener error', err);
        });
      } else {
        currentUser = null;
        renderAuthUI(null);
        if (cartUnsubscribe) cartUnsubscribe();
        localCart = { items: [], total: 0 };
        renderCart();
      }
    });

    function renderAuthUI(user) {
      if (user) {
        authArea.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;">
            <img src="${user.photoURL || ''}" alt="avatar" style="width:34px;height:34px;border-radius:50%;object-fit:cover;">
            <div style="text-align:right;">
              <div style="font-size:13px">Hi, <strong>${user.displayName}</strong></div>
              <div class="muted" style="font-size:12px">${user.email}</div>
            </div>
            <div style="margin-left:8px;">
              <button id="logoutBtn" class="btn secondary">Logout</button>
            </div>
          </div>
        `;
        document.getElementById('logoutBtn').onclick = signOutUI;

        // show admin if email in ADMINS
        if (ADMINS.includes(user.email)) {
          adminArea.style.display = 'block';
        } else {
          adminArea.style.display = 'none';
        }
      } else {
        authArea.innerHTML = `<button id="googleLogin" class="btn">Login with Google</button>`;
        document.getElementById('googleLogin').onclick = () => signInWithPopup(auth, provider);
        adminArea.style.display = 'none';
      }
    }

    // ---------- PRODUCTS: load & render ----------
    async function loadProducts() {
      productGrid.innerHTML = '<p class="muted">Loading products...</p>';
      try {
        const snapshot = await getDocs(collection(db, 'products'));
        productGrid.innerHTML = '';
        if (snapshot.empty) {
          productGrid.innerHTML = '<p class="muted">No products found.</p>';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          const prod = createProductCard(id, data);
          productGrid.appendChild(prod);
        });
      } catch (err) {
        console.error('Error loading products', err);
        productGrid.innerHTML = '<p class="muted" style="color:crimson">Failed to load products</p>';
      }
    }

    function createProductCard(id, product) {
      const el = document.createElement('div');
      el.className = 'card product';
      el.style.display = 'flex';
      el.style.flexDirection = 'column';
      el.innerHTML = `
        <div style="height:180px;overflow:hidden;border-radius:8px;">
          <img src="${product.image || 'https://via.placeholder.com/400x250?text=Product'}" alt="${product.name || ''}" style="width:100%;height:100%;object-fit:cover;">
        </div>
        <div style="padding:8px 0;">
          <h3 style="margin:6px 0 4px">${product.name || 'Untitled'}</h3>
          <div class="muted" style="font-size:13px">${product.description || ''}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <div style="font-weight:700;">$${formatPrice(product.price || 0)}</div>
            <div><button class="btn" data-id="${id}" data-name="${escapeHtml(product.name||'')}" data-price="${product.price||0}">Add to cart</button></div>
          </div>
        </div>
      `;
      // add event listener
      el.querySelector('button.btn').onclick = (e) => {
        addToCart(id, product);
      };
      return el;
    }

    // ---------- CART: local modifications + sync to Firestore ----------
    async function addToCart(productId, product) {
      if (!currentUser) return showNotification('Please sign in to add to cart');
      // find if product exists
      const idx = localCart.items.findIndex(i => i.id === productId);
      if (idx > -1) {
        localCart.items[idx].quantity += 1;
      } else {
        localCart.items.push({ id: productId, name: product.name, price: product.price, quantity: 1 });
      }
      localCart.total = localCart.items.reduce((s, it) => s + (it.price * (it.quantity||1)), 0);
      try {
        await setDoc(cartDocRef, localCart);
        showNotification('Added to cart');
      } catch (err) {
        console.error('Error saving cart', err);
        showNotification('Could not update cart');
      }
    }

    function renderCart() {
      cartItemsDiv.innerHTML = '';
      if (!localCart.items || localCart.items.length === 0) {
        cartItemsDiv.innerHTML = '<p class="muted">Cart is empty</p>';
        cartTotalSpan.textContent = '0.00';
        return;
      }
      localCart.items.forEach(item => {
        const p = document.createElement('div');
        p.style.display = 'flex';
        p.style.justifyContent = 'space-between';
        p.style.marginBottom = '6px';
        p.innerHTML = `<div>${escapeHtml(item.name)} <span class="muted"> x ${item.quantity}</span></div><div>$${formatPrice(item.price * item.quantity)}</div>`;
        cartItemsDiv.appendChild(p);
      });
      cartTotalSpan.textContent = formatPrice(localCart.total || 0);
    }

    clearCartBtn.onclick = async () => {
      if (!currentUser) return showNotification('Login to clear cart');
      localCart = { items: [], total: 0 };
      try {
        await setDoc(cartDocRef, localCart);
        showNotification('Cart cleared');
      } catch (err) {
        console.error(err);
        showNotification('Could not clear cart');
      }
    };

    checkoutBtn.onclick = async () => {
      if (!currentUser) return showNotification('Please sign in to checkout');
      if (!localCart.items || localCart.items.length === 0) return showNotification('Cart is empty');
      const address = shippingBox.value.trim();
      if (!address) return showNotification('Enter shipping address');

      try {
        // save order under users/{uid}/orders
        await addDoc(collection(db, 'users', currentUser.uid, 'orders'), {
          name: currentUser.displayName,
          email: currentUser.email,
          cartItems: localCart.items,
          totalPrice: localCart.total,
          address,
          status: 'pending',
          time: new Date().toISOString()
        });
        // clear cart
        localCart = { items: [], total: 0 };
        await setDoc(cartDocRef, localCart);
        shippingBox.value = '';
        showNotification('Order placed! ‚úÖ');
      } catch (err) {
        console.error('Checkout error', err);
        showNotification('Failed to place order');
      }
    };

    // ---------- ADMIN: add product ----------
    addProductBtn.onclick = async () => {
      if (!currentUser) return showNotification('Sign in as admin to add product');
      if (!ADMINS.includes(currentUser.email)) return showNotification('Not an admin');
      const name = pName.value.trim();
      const price = Number(pPrice.value);
      const image = pImage.value.trim();
      const desc = pDesc.value.trim();
      if (!name || !price) return showNotification('Name and price required');

      try {
        await addDoc(collection(db, 'products'), {
          name, price, image, description: desc
        });
        pName.value = pPrice.value = pImage.value = pDesc.value = '';
        showNotification('Product added');
        // reload products
        loadProducts();
      } catch (err) {
        console.error('Add product error', err);
        showNotification('Could not add product');
      }
    };

    // ---------- Util: escape HTML (small) ----------
    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (m) => {
        return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
      });
    }

    // ---------- INITIAL LOAD ----------
    // Load products on start
    loadProducts();

    // Optional: poll or re-load periodically or set up real-time listener for products if you prefer:
    // onSnapshot(collection(db, 'products'), (snap) => { /* render realtime */ });

  </script>
</body>
</html>
