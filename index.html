<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firestore Store with Gift Card</title>
<style>
  body{font-family:'Poppins',sans-serif;margin:0;padding:0;background:#f6f7fb;}
  #loginPage{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
    position:fixed;top:0;left:0;right:0;bottom:0;background:#f6f7fb;z-index:100;}
  .google-btn{background:#4285F4;color:white;padding:10px 18px;border:none;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;gap:10px;}
  nav{background:#222;color:white;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;}
  nav input{padding:6px 10px;border-radius:8px;border:none;outline:none;}
  nav button{border:none;border-radius:8px;padding:6px 12px;cursor:pointer;}
  #logoutBtn{background:#f44336;color:white;}
  #cartBtn,#accountBtn{background:#4CAF50;color:white;}
  #product-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:20px;}
  .product{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:10px;text-align:center;}
  .product img{width:100%;height:180px;object-fit:cover;border-radius:8px;}
  .add-btn{background:#4CAF50;color:white;border:none;padding:6px 12px;border-radius:8px;margin-top:6px;cursor:pointer;}
  #accountPopup,#checkoutPopup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:20;}
  .popup-box{background:white;padding:20px;border-radius:10px;width:400px;max-height:90vh;overflow-y:auto;}
  .popup-box h2{margin-top:0;}
  .popup-box input{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ccc;}
  .popup-box button{width:100%;margin-top:10px;padding:10px;border:none;border-radius:8px;cursor:pointer;}
  #closeAccount,#closeCheckout{background:#f44336;color:white;}
  #redeemBtn,#placeOrder{background:#4CAF50;color:white;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <h1>Welcome to Firestore Store üõçÔ∏è</h1>
  <button id="googleLogin" class="google-btn">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google
  </button>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  <nav>
    <div>Firestore Store</div>
    <input type="text" id="searchBar" placeholder="Search products...">
    <div>
      <button id="accountBtn">üë§ Account</button>
      <button id="cartBtn">üõí Cart</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div id="product-grid"></div>
</div>

<!-- ACCOUNT POPUP -->
<div id="accountPopup">
  <div class="popup-box">
    <h2>Your Account</h2>
    <p><b>Name:</b> <span id="accName"></span></p>
    <p><b>Email:</b> <span id="accEmail"></span></p>
    <p><b>Balance:</b> ‚Çπ<span id="accBalance">0</span></p>
    <hr>
    <h3>Redeem Gift Card</h3>
    <input id="giftCode" placeholder="Enter Gift Card Code">
    <button id="redeemBtn">Redeem</button>
    <button id="closeAccount">Close</button>
  </div>
</div>

<!-- CHECKOUT POPUP (unchanged example) -->
<div id="checkoutPopup">
  <div class="popup-box">
    <h2>Shipping Address</h2>
    <input id="rName" placeholder="Recipient Name">
    <input id="rStreet1" placeholder="Street Address 1">
    <input id="rCity" placeholder="City">
    <button id="placeOrder">Place Order</button>
    <button id="closeCheckout">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyD7CGdjI-VaNl2AnB54dPAVBh9mAIF9j7o",
  authDomain:"thelong-6274a.firebaseapp.com",
  projectId:"thelong-6274a",
  storageBucket:"thelong-6274a.firebasestorage.app",
  messagingSenderId:"729094241594",
  appId:"1:729094241594:web:17b32ea302bb45814fa403"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginPage=document.getElementById("loginPage");
const appDiv=document.getElementById("app");
const googleLogin=document.getElementById("googleLogin");
const logoutBtn=document.getElementById("logoutBtn");
const accountBtn=document.getElementById("accountBtn");
const accountPopup=document.getElementById("accountPopup");
const accName=document.getElementById("accName");
const accEmail=document.getElementById("accEmail");
const accBalance=document.getElementById("accBalance");
const giftCode=document.getElementById("giftCode");
const redeemBtn=document.getElementById("redeemBtn");
const closeAccount=document.getElementById("closeAccount");

let currentUser=null;

/* LOGIN */
googleLogin.onclick=()=>signInWithPopup(auth,provider);
logoutBtn.onclick=()=>signOut(auth);

/* STATE */
onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUser=user;
    loginPage.style.display="none";
    appDiv.style.display="block";
    await loadAccount();
  }else{
    currentUser=null;
    appDiv.style.display="none";
    loginPage.style.display="flex";
  }
});

/* ACCOUNT FUNCTIONS */
accountBtn.onclick=()=>accountPopup.style.display="flex";
closeAccount.onclick=()=>accountPopup.style.display="none";

async function loadAccount(){
  const ref=doc(db,"users",currentUser.uid);
  const snap=await getDoc(ref);
  let bal=0;
  if(!snap.exists()){
    await setDoc(ref,{name:currentUser.displayName,email:currentUser.email,balance:0});
  }else{
    bal=snap.data().balance||0;
  }
  accName.innerText=currentUser.displayName;
  accEmail.innerText=currentUser.email;
  accBalance.innerText=bal;
}

/* GIFT CARD REDEEM */
redeemBtn.onclick=async()=>{
  const code=giftCode.value.trim();
  if(!code)return alert("Enter a gift card code!");

  // example: you can store giftCards collection manually
  const ref=doc(db,"giftCards",code);
  const snap=await getDoc(ref);
  if(!snap.exists())return alert("‚ùå Invalid code!");
  const card=snap.data();
  if(card.used) return alert("‚ö†Ô∏è This code is already used!");

  const userRef=doc(db,"users",currentUser.uid);
  const userSnap=await getDoc(userRef);
  const currentBal=userSnap.exists()?userSnap.data().balance||0:0;
  const newBal=currentBal+card.value;

  await updateDoc(userRef,{balance:newBal});
  await updateDoc(ref,{used:true,usedBy:currentUser.uid});
  accBalance.innerText=newBal;
  alert(`üéâ ‚Çπ${card.value} added to your balance!`);
  giftCode.value="";
};
</script>
</body>
</html>
